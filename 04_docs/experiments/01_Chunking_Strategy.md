# 청킹 전략 실험 (Chunking Strategy)

> **Summary**: 단순 텍스트 분할 vs 구조 기반 청킹을 비교 실험한 결과, **하이브리드 청킹 방식**이 문맥 보존과 길이 제어를 모두 만족하여 최종 선정되었습니다.

## 1. 실험 목적

한국사 문서의 구조 정보(제목, 본문, 이미지)를 보존하면서도 임베딩 모델의 Context Window 제한을 고려한 최적의 청킹 전략을 찾기 위함.

## 2. 비교 후보군

| 후보 | 방식 | 장점 | 단점 |
|------|------|------|------|
| **A. RecursiveCharacterTextSplitter** | 1000자 단위 기계적 분할 | 구현 간단, 범용적 | 문맥 단절, 제목-본문 분리 |
| **B. Structure-Aware** | JSON 구조 기반 청킹 | 문맥 보존, 멀티모달 지원 | **초대형 청크 발생** (최대 1,919자) |
| **C. Hybrid (최종 선정)** | 구조 기반 + 길이 제어 | 문맥 보존 + 안전한 길이 | 구현 복잡도 증가 |

## 3. 실험 결과

### 3.1 1차 실험 (Structure-Aware Only)

**결과**: 총 3,077개 청크 생성

**문제점**: 1,500자 이상 초대형 청크 3개 발견
- `chk_001324`: 1,834자 (이미지 OCR 오류)
- `chk_001566`: 1,796자 (긴 텍스트)
- `chk_002793`: 1,919자 (이미지 OCR 오류)

**위험성**: 임베딩 모델의 Context Window 초과로 정보 유실 가능

### 3.2 2차 실험 (Hybrid Chunking) - 최종 채택

**수정 사항**:
- 이미지 청크: 500자 초과 시 Truncate
- 텍스트 청크: 1,000자 초과 시 문장 단위 재분할
- Overlap: 100자 적용

**최종 결과**:
- 총 청크 수: **3,719개** (+642개)
- 평균 길이: **471.4자** (안전 범위)
- 최대 길이: **1,063자** (1차 대비 45% 감소)
- 타입별 분포:
  - 텍스트: 3,353개 (90.2%)
  - 이미지: 346개 (9.3%)
  - 표: 20개 (0.5%)

## 4. 성공 사례

**샘플 청크 구조:**
```json
{
  "chunk_id": "chk_000000",
  "text": "[천주교 탄압으로유배길에 오르다] 정조 다음 왕위에 오른 인물은...",
  "metadata": {
    "source": "벌거벗은한국사-조선편",
    "page": 1,
    "type": "text"
  }
}
```

**핵심 개선점:**
- 제목이 본문 앞에 붙어 문맥 보존
- 이미지 OCR 텍스트가 별도 청크로 분리되어 검색 가능
- 초대형 청크 완전 제거

## 5. 결론

**최종 선택: Hybrid Chunking**

**선정 근거:**
1. 구조 기반 청킹의 장점(문맥 보존, 멀티모달) 유지
2. 길이 제어 로직으로 안전성 확보
3. 임베딩 모델 제한 고려한 최적화

---

**관련 파일**: `backend/02_Chunking/`
