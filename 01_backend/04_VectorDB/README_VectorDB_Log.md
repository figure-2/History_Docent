# [VectorDB] 벡터 데이터베이스 구축 로그
- **작성 일시:** 2025-11-22 11:10
- **작성자:** Pencilfoxs

---

## 1. 가설 (Hypothesis)

### 1.1 초기 가정
- **가설 1:** 3,719개 청크 규모에서는 **ChromaDB**가 FAISS나 Pinecone보다 관리가 편하고, 메타데이터 필터링 기능이 내장되어 있어 RAG 시스템 구축에 더 적합할 것이다.
- **가설 2:** 이미 생성된 1024차원 임베딩 벡터를 ChromaDB에 적재하면, JSON 파일 기반 검색보다 **검색 속도가 100배 이상 향상**될 것이다.
- **가설 3:** ChromaDB의 메타데이터 필터링 기능을 활용하면, "특정 PDF 파일에서만 검색" 같은 고급 검색 기능을 쉽게 구현할 수 있을 것이다.
- **예상 결과:** ChromaDB 구축 후 평균 검색 시간이 2-3ms 이하로 나올 것으로 예상하며, 메타데이터 필터링도 정상 작동할 것으로 기대한다.

---

## 2. 실험 설계 (Experiment Design)

### 2.1 벡터 DB 선정 배경
- **목적:** 3,719개 청크의 임베딩 벡터를 효율적으로 저장하고, 사용자 질문에 대한 고속 유사도 검색을 수행하기 위해 벡터 데이터베이스가 필요했다.
- **요구사항:**
  1. 로컬 환경에서 구동 가능 (서버 설치 불필요)
  2. 메타데이터 필터링 지원 (source, page, type 등)
  3. 검색 속도: 10ms 이하
  4. 데이터 영속성 (재시작 후에도 유지)

### 2.2 후보군 선정 이유 (Why Candidates)

| 후보 | 선정 이유 | 특징 및 기대 효과 |
|---|---|---|
| **ChromaDB** | **최종 선택** | AI 네이티브 오픈소스 DB, All-in-One (벡터+텍스트+메타데이터), 로컬 파일 기반, 메타데이터 필터링 내장 |
| FAISS | 검토 대상 | Meta의 고속 검색 라이브러리, 매우 빠름, 하지만 벡터만 저장하고 텍스트/메타데이터는 별도 관리 필요 |
| Pinecone / Qdrant | 제외 | 클라우드/서버형 DB, 3,700개 규모에는 오버헤드, 네트워크 지연 발생 |

### 2.3 비교 기준 (Criteria)
- **1차 필터링 (정량 평가):**
  - **검색 속도:** 평균 검색 시간 (목표: 10ms 이하)
  - **데이터 적재 시간:** 3,719개 청크 적재 소요 시간
  - **메타데이터 필터링 성능:** 필터링 적용 시 검색 속도
- **2차 필터링 (정성 평가):**
  - 실제 검색 결과의 정확도 (상위 5개 문서가 관련 있는지 확인)
  - 메타데이터 필터링 기능의 사용 편의성
  - 코드 복잡도 및 유지보수성

---

## 3. 검증 결과 (Validation)

### 3.1 정량 평가 결과 (Quantitative Results)

#### 3.1.1 데이터 적재 성능
- **총 청크 수:** 3,719개
- **데이터 로드 시간:** 2.60초
- **데이터 변환 시간:** 0.01초
- **ChromaDB 적재 시간:** 7.13초 (배치 크기: 1000개)
- **총 소요 시간:** 약 10초

#### 3.1.2 검색 성능 벤치마크

**평균 성능 (10회 반복 테스트):**
- **임베딩 생성 시간:** 18.80ms (BGE-m3, CUDA 사용)
- **벡터 검색 시간:** 2.37ms (ChromaDB)
- **총 소요 시간:** 21.17ms

**개별 쿼리 성능:**
| 쿼리 | 임베딩 생성 (ms) | 검색 (ms) | 총 시간 (ms) |
|---|---|---|---|
| 세종대왕이 만든 한글 | 658.11 | 3.59 | 661.70 |
| 임진왜란 | 20.17 | 2.67 | 22.84 |
| 조선왕조실록 | 19.45 | 2.58 | 21.03 |
| 정약용의 실학 | 18.89 | 2.52 | 21.41 |
| 고려시대 무역 | 18.87 | 2.56 | 21.43 |

**주요 발견:**
- 첫 번째 쿼리에서 임베딩 생성 시간이 658ms로 길었으나, 이는 모델 초기 로딩 시간 포함 (두 번째부터는 18-20ms로 안정화)
- **벡터 검색 시간은 평균 2.37ms로 목표(10ms)를 크게 상회하는 성능 달성**
- JSON 파일 기반 검색(약 1-2초) 대비 **약 500배 빠른 검색 속도**

#### 3.1.3 메타데이터 필터링 성능
- **필터링 적용 검색:** 정상 작동 확인
- **필터 조건:** `source == '벌거벗은한국사-조선편'`
- **검색 결과:** 3개 문서 반환 (필터링 정상 작동)

### 3.2 정성 평가 및 실패 분석 (Qualitative & Failure Analysis)

#### 3.2.1 성공 사례 분석

**검색 정확도 검증:**
- **쿼리: "세종대왕이 만든 한글"**
  - 1위 문서: "한글"이라는 이름의 유래와 세종대왕의 한글 창제에 대한 내용
  - 거리: 0.6996 (낮을수록 유사)
  - **결론:** 매우 관련성 높은 문서가 1위로 검색됨 ✅

- **쿼리: "임진왜란"**
  - 1위 문서: 임진왜란과 정유재란에 대한 상세 설명
  - 거리: 1.0875
  - **결론:** 정확한 주제의 문서 검색 성공 ✅

- **쿼리: "정약용의 실학"**
  - 1위 문서: 정약용이 실학을 접한 과정과 실학에 대한 내용
  - 거리: 0.7140
  - **결론:** 관련성 높은 문서 검색 성공 ✅

**메타데이터 필터링 검증:**
- **필터 조건:** `source == '벌거벗은한국사-조선편'`
- **결과:** 해당 소스의 문서만 정확히 필터링되어 반환됨
- **결론:** 메타데이터 필터링 기능 정상 작동 ✅

#### 3.2.2 실패 사례 분석

**초기 오류: `query_texts` 사용 시 차원 불일치**
- **문제:** `collection.query(query_texts=[...])` 사용 시 ChromaDB가 기본 모델로 384차원 임베딩을 생성하여, 저장된 1024차원 임베딩과 불일치 발생
- **원인:** ChromaDB의 기본 임베딩 함수가 다르거나 설정되지 않아 자동으로 다른 모델을 사용
- **해결:** `query_embeddings` 파라미터를 사용하여 BGE-m3로 생성한 1024차원 임베딩을 직접 전달하도록 수정
- **조치:** 검색 스크립트에서 BGE-m3 모델을 로드하여 쿼리 임베딩을 생성한 후 `query_embeddings`로 전달하도록 변경

#### 3.2.3 Collection 통계

**소스별 문서 수:**
- 벌거벗은한국사-사건편: 393개
- 벌거벗은한국사-권력편: 392개
- 벌거벗은한국사-영웅편: 389개
- 벌거벗은한국사-인물편: 388개
- 벌거벗은한국사-조선편: 374개
- 벌거벗은한국사-고려편: 357개
- 벌거벗은한국사-근현대편: 341개
- 조선왕조실록 시리즈: 210-230개 (총 1,085개)

**타입별 문서 수:**
- text: 3,353개 (90.2%)
- figure: 346개 (9.3%)
- table: 20개 (0.5%)

---

## 4. 의사결정 (Conclusion & Pivot)

### 4.1 최종 선정 벡터 DB
- **선정 DB:** **ChromaDB (PersistentClient)**
- **선정 근거:**
  1. **검색 속도:** 평균 2.37ms로 목표(10ms)를 크게 상회하는 성능 달성
  2. **All-in-One 기능:** 벡터, 텍스트, 메타데이터를 한 번에 관리하여 코드 복잡도가 낮음
  3. **메타데이터 필터링:** 내장 기능으로 고급 검색 기능 구현이 용이함
  4. **로컬 구동:** 서버 설치 없이 Python 라이브러리로 사용 가능
  5. **데이터 영속성:** 로컬 파일 기반으로 재시작 후에도 데이터 유지

### 4.2 Pivot (계획 변경 사항)
- **초기 계획:** FAISS도 검토 대상으로 고려했으나, 메타데이터 관리의 복잡도와 코드 유지보수성을 고려하여 ChromaDB를 선택함.
- **검색 방식 변경:** 초기에는 `query_texts`를 사용하려 했으나, 차원 불일치 문제로 `query_embeddings`를 직접 전달하는 방식으로 변경. 이는 BGE-m3 모델을 명시적으로 사용하여 일관성을 보장하는 장점이 있음.

### 4.3 최종 완료 사항
1. ✅ **ChromaDB 벡터 DB 구축 완료:** 3,719개 청크의 임베딩 벡터를 ChromaDB에 적재 완료 (2025-11-22 11:04)
2. ✅ **검증 테스트 완료:** 다양한 쿼리로 검색 성능 및 정확도 검증 완료 (2025-11-22 11:05)
3. ✅ **메타데이터 필터링 기능 확인:** 소스별 필터링 기능 정상 작동 확인
4. ⏳ **향후 계획:**
   - RAG 검색 모듈 개발: 사용자 질문을 받아 임베딩 생성 → ChromaDB 검색 → 상위 K개 문서 반환
   - 검색 결과 재랭킹(Re-ranking) 모듈 추가 (선택사항)

---

## 5. 참고 자료
- **벡터 DB 구축 스크립트:** `build_vectordb.py`
- **검증 스크립트:** `verify_vectordb.py`
- **구축 로그:** `build_vectordb.log`
- **검증 로그:** `verify_vectordb.log`
- **DB 경로:** `04_VectorDB/chroma_db/`
- **Collection 이름:** `korean_history_chunks`
- **ChromaDB 문서:** [ChromaDB Documentation](https://docs.trychroma.com/)

