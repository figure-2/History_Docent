# 작업 로그: Chunking 단계

**작성 일시:** 2025-11-22 07:14 (초기 작성)  
**최종 수정일:** 2025-11-22 07:52 (하이브리드 청킹 개선 반영)

---

## 1. 가설 (Hypothesis)

### 초기 가정
- **가설 1**: Upstage JSON의 구조 정보(Heading, Paragraph, Figure)를 보존하여 청킹하면, 단순 텍스트 분할(RecursiveCharacterTextSplitter)보다 검색 문맥(Context) 파악 능력이 우수할 것이다.
- **가설 2**: 이미지의 OCR 텍스트(`alt` 속성)를 별도 청크로 분리하면, 지도나 도표 내의 정보도 검색 대상이 되어 RAG 성능이 향상될 것이다.
- **가설 3**: 제목(Heading)을 본문 앞에 붙여서 저장하면, "세종대왕의 업적" 같은 질문에 대해 제목과 본문이 함께 검색되어 정확도가 높아질 것이다.

### 작업 전 예상 결과
- 총 청크 수: 약 5,000~10,000개 (데이터셋 규모에 따라)
- 청크 평균 길이: 200~800자 (제목 포함)
- 이미지/표 청크 비율: 약 5~10%

---

## 2. 실험 설계 (Experiment Design)

### 비교군 선정 (Why Candidates)

#### 후보군 A: 기존 방식 (RecursiveCharacterTextSplitter)
- **선정 이유**: `History_Docent_PJ_gemini` 프로젝트에서 사용 중인 표준 방식
- **방식**: 텍스트를 1000자 단위로 기계적으로 분할
- **장점**: 구현이 간단하고 모든 텍스트 파일에 적용 가능
- **단점**: 문맥이 끊기고, 제목과 본문이 분리될 수 있음

#### 후보군 B: 구조 기반 청킹 (Structure-Aware Chunking) - **1차 시도**
- **선정 이유**: 
  1. Upstage API가 이미 문서 구조를 분석하여 제공함 (고비용 데이터)
  2. JSON 내부에 `category`(heading, paragraph, figure) 정보가 명확히 존재
  3. HTML 태그로 구조가 보존되어 있어 파싱이 용이함
- **방식**: 
  - Heading을 추적하여 본문에 문맥 주입
  - 이미지/표는 별도 타입으로 분리
  - 짧은 문단은 병합, 긴 문단은 문장 단위로 분할
- **장점**: 검색 정확도 향상, 문맥 보존, 멀티모달 데이터 활용
- **단점**: JSON 파싱 코드 작성 필요 (복잡도 증가), **길이 제어 부족으로 초대형 청크 발생**

#### 후보군 C: 하이브리드 청킹 (Hybrid Chunking) - **최종 채택**
- **선정 이유**: 
  1. 후보군 B의 장점(구조 보존)을 유지하면서
  2. 후보군 A의 장점(길이 제어)을 결합하여
  3. 임베딩 모델의 Context Window 제한을 고려한 안전한 청킹
- **방식**: 
  - 기본: 구조 기반 청킹 (Heading 추적, 이미지/표 분리)
  - 보완: 1,000자 초과 텍스트는 문장 단위 재분할 (Recursive Splitting)
  - 보완: 500자 초과 이미지 OCR은 Truncate (노이즈 방지)
- **장점**: 구조 보존 + 길이 제어의 이점 결합, 안정성 향상
- **단점**: 구현 복잡도 증가 (2단계 처리)

### 비교 기준 (Criteria)

1. **정량 평가 (Quantitative)**
   - 청크 수: 너무 많으면 검색 비용 증가, 너무 적으면 정확도 저하
   - 평균 청크 길이: 200~1000자 범위가 적정
   - 메타데이터 완성도: source, page, type 필드 존재 여부

2. **정성 평가 (Qualitative)**
   - 제목과 본문이 함께 저장되는지 (문맥 보존)
   - 이미지 OCR 텍스트가 별도 청크로 분리되는지
   - 문장이 중간에 끊기지 않는지 (완결성)

### 테스트 데이터셋
- **출처**: `/home/pencilfoxs/00_new/History_Docent/01_Data_Preprocessing`
- **포함 폴더**: 
  - `벌거벗은한국사-조선편`
  - `벌거벗은한국사-고려편`
  - `조선왕조실록1` ~ `조선왕조실록5`
  - 기타 역사 관련 PDF 분석 결과물

---

## 3. 검증 결과 (Validation)

### 실행 결과

**실행 명령:**
```bash
cd /home/pencilfoxs/00_new/History_Docent/02_Chunking
python upstage_chunker.py
```

### 3.1. 1차 실험 결과 (후보군 B: 순수 구조 기반)

**실행 명령:**
```bash
cd /home/pencilfoxs/00_new/History_Docent/02_Chunking
python upstage_chunker.py
python verify_chunks.py
```

**결과 통계:**
- 처리된 JSON 파일 수: **205개**
- 생성된 총 청크 수: **3,077개**
- 청크 평균 길이: **546.8자**
- 최소 길이: 5자
- **최대 길이: 1,919자** ⚠️
- 타입별 분포:
  - 텍스트 (text): 2,711개 (88.1%)
  - 이미지 (figure): 346개 (11.2%)
  - 표 (table): 20개 (0.7%)

**문제점 발견:**
- **1,500자를 초과하는 초대형 청크 3개 발견**
  - `chk_001324`: 1,834자 (이미지 OCR, 깨진 텍스트)
  - `chk_001566`: 1,796자 (텍스트, "화포와 총통" 주제)
  - `chk_002793`: 1,919자 (이미지 OCR, 깨진 텍스트)
- **원인 분석:**
  - 이미지 OCR 텍스트가 깨져서 길게 이어짐
  - 문단 구분이 없는 긴 텍스트가 통째로 묶임
- **위험성:**
  - 임베딩 모델의 Context Window 초과로 인한 정보 유실(Truncation) 발생 가능
  - 검색 시 뒷부분 내용이 누락될 위험

### 3.2. 2차 실험 결과 (후보군 C: 하이브리드 청킹) - **최종 채택**

**수정 내용:**
- 이미지(Figure) 청크: 500자 초과 시 Truncate (OCR 오류 방지)
- 텍스트(Text) 청크: 1,000자 초과 시 문장 단위 재분할 (Recursive Splitting)
- Overlap: 100자 적용하여 문맥 단절 방지

**실행 명령:**
```bash
cd /home/pencilfoxs/00_new/History_Docent/02_Chunking
python upstage_chunker.py  # 수정된 코드 실행
python verify_chunks.py    # 재검증
```

**결과 통계 (최종):**
- 처리된 JSON 파일 수: **205개**
- 생성된 총 청크 수: **3,719개** (+642개, 분할 효과)
- 청크 평균 길이: **471.4자** (개선됨)
- 최소 길이: 5자
- **최대 길이: 1,063자** ✅ (안전 범위 진입)
- 타입별 분포:
  - 텍스트 (text): 3,353개 (90.2%)
  - 이미지 (figure): 346개 (9.3%)
  - 표 (table): 20개 (0.5%)

**개선 효과:**
- ✅ 1,500자 이상 청크 완전 제거
- ✅ 평균 길이 최적화 (546.8자 → 471.4자)
- ✅ 데이터 무결성 유지 (빈 텍스트 0개, 소스 누락 0개)

### 성공 사례 분석

**샘플 청크 예시:**
```json
{
  "chunk_id": "chk_000000",
  "text": "[천주교 탄압으로유배길에 오르다] 정조 다음 왕위에 오른 인물은 정조의 아들인 열한 살의 순조였습니다...",
  "metadata": {
    "source": "벌거벗은한국사-조선편",
    "page": 1,
    "type": "text"
  }
}
```

**이미지 청크 예시:**
```json
{
  "chunk_id": "chk_000003",
  "text": "[이미지] [<황사영 백서>] MISSION DE SEOUL (COR EE) LETTRE D'AL ALEXANDRE HOANG...",
  "metadata": {
    "source": "벌거벗은한국사-조선편",
    "page": 2,
    "type": "figure"
  }
}
```

**검증 포인트:**
- ✅ 제목이 본문 앞에 붙어있음 (문맥 보존)
- ✅ 메타데이터에 출처와 페이지 정보 포함
- ✅ 타입 구분 명확 (text/image/table)

### 3.3. 정성 평가 (Qualitative Analysis)

**성공 사례:**
- ✅ 제목이 본문 앞에 붙어 문맥이 명확함
  - 예: `[천주교 탄압으로유배길에 오르다] 정조 다음 왕위에 오른 인물은...`
- ✅ 이미지 OCR 텍스트가 별도 청크로 분리되어 검색 가능
  - 예: `[이미지] [<황사영 백서>] MISSION DE SEOUL...`
- ✅ 메타데이터에 출처, 페이지, 타입 정보 포함

**실패(보완) 사례:**
- ⚠️ 20자 미만의 아주 짧은 청크 24개 존재 (0.6%)
  - 예: `[비] ·`, `[무제] 벌거벗은임꺽정의 난`
  - **판단**: 검색에 치명적이지 않아 무시(Ignore) 결정
- ✅ 1차 실험에서 발견된 초대형 청크 문제는 2차 실험에서 완전 해결됨

---

## 4. 의사결정 (Conclusion & Pivot)

### 최종 선택: 후보군 C (하이브리드 청킹)

**채택 근거:**
1. **데이터 손실 방지**: 순수 구조 기반(B)의 문제였던 "초대형 청크로 인한 정보 잘림" 현상을 완벽히 해결함
2. **멀티모달 지원**: 기존 방식(A)에서는 불가능했던 이미지, 도표 검색이 가능함
3. **검색 품질 최적화**: 제목(Heading)을 본문에 주입(Injection)하여 "세종대왕 업적" 같은 키워드 검색 시 정확도(Relevance)를 극대화함
4. **안정성 보장**: 임베딩 모델의 Context Window 제한을 고려하여 안전한 길이 범위 유지

### 계획 유지/수정 사항

**유지:**
- Heading 추적 로직 (구조 보존)
- 이미지/표 분리 처리 (멀티모달 지원)
- 메타데이터 주입 (추적 가능성)

**수정 (Pivot):**
- ✅ **길이 제어 로직 추가**: 1,000자 초과 텍스트는 문장 단위 재분할
- ✅ **이미지 OCR 길이 제한**: 500자 초과 시 Truncate (노이즈 방지)
- ✅ **Overlap 적용**: 재분할 시 100자 중복으로 문맥 단절 방지

---

## 5. 다음 단계

1. **임베딩 생성** (`03_Embedding`): 생성된 `all_chunks.json`을 벡터로 변환
2. **벡터 DB 구축** (`04_Vector_DB`): ChromaDB에 임베딩 저장
3. **검색 테스트** (`05_Retrieval`): 실제 질문으로 검색 정확도 검증

---

---

## 5. 실험 및 검증 원칙 준수 (Evaluation Principles)

### 5.1. 정량 평가 (Quantitative)
- **청크 수**: 3,719개 (적정 범위)
- **평균 길이**: 471.4자 (200~1,000자 범위 내)
- **최대 길이**: 1,063자 (임베딩 모델 제한 고려)
- **데이터 무결성**: 빈 텍스트 0개, 소스 누락 0개

### 5.2. 정성 평가 (Qualitative)
- **샘플 검증**: 20개 이상 청크 직접 확인
- **문맥 보존**: 제목과 본문 결합 확인
- **멀티모달**: 이미지/표 별도 처리 확인

### 5.3. 실패 분석 (Failure Analysis)
- **초대형 청크 문제**: 구조 기반 청킹의 부작용으로 발견 → 하이브리드 방식으로 해결
- **원인**: 이미지 OCR 오류 및 문단 구분 부재
- **해결**: 길이 기반 강제 분할 로직 추가

---

## 6. 다음 단계

1. **임베딩 생성** (`03_Embedding`): 생성된 `all_chunks.json`을 벡터로 변환
2. **벡터 DB 구축** (`04_Vector_DB`): ChromaDB에 임베딩 저장
3. **검색 테스트** (`05_Retrieval`): 실제 질문으로 검색 정확도 검증

---

**작성자:** AI Assistant  
**검토자:** [사용자명]  
**최종 수정일:** 2025-11-22 07:52

