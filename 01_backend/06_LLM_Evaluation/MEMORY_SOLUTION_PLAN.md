# 메모리 부족 문제 해결 방안

**작성 일시:** 2025-11-23 15:00

---

## 1. 현재 상황 분석

### 1.1 선정된 모델 상태

**선정된 모델:** `MLP-KTLim/llama-3-Korean-Bllossom-8B`

**실행 상태:**
- ✅ **정상 작동 확인**: 49개 질문 모두 성공 (100%)
- ✅ **메모리 문제 없음**: 벤치마크 완료
- ✅ **평균 지연시간**: 6.98초 (4개 모델 중 가장 빠름)

**결론:** **선정된 모델은 그대로 사용 가능합니다!**

### 1.2 메모리 부족 발생 원인

**문제가 발생한 모델:**
- ❌ Qwen-14B: GPU 메모리 부족 (29.35 GiB 사용)
- ❌ Qwen-32B: 시스템 메모리 부족 + Java 크래시

**선정된 모델과의 차이:**
- Bllossom-8B: 약 16GB GPU 메모리 사용 (정상)
- Qwen-14B: 약 29GB GPU 메모리 사용 (부족)
- Qwen-32B: 매우 큰 메모리 요구량 (부족)

---

## 2. 해결 방안

### 2.1 옵션 1: 선정된 모델 그대로 사용 (권장) ⭐

**장점:**
- ✅ 이미 검증 완료 (성공률 100%)
- ✅ 메모리 문제 없음
- ✅ 가장 빠른 응답 속도
- ✅ 추가 작업 불필요

**전제 조건:**
- Swap 메모리 활성화 (안정성 향상)
- 메모리 모니터링 (재발 방지)
- 배치 처리 (전체 Validation Set 테스트 시)

**결론:** **이 방법을 권장합니다!**

---

### 2.2 옵션 2: 더 작은 모델 선택

**후보 모델:**
- `beomi/Llama-3-Open-Ko-8B` (이미 테스트 완료, 성공률 100%)
- `MLP-KTLim/llama-3-Korean-Bllossom-8B` (현재 선정 모델)

**단점:**
- 이미 Bllossom-8B가 최고 성능
- 다른 모델로 변경할 이유 없음

**결론:** **불필요합니다.**

---

### 2.3 옵션 3: 하드웨어 업그레이드

**필요 사항:**
- GPU: A100 80GB 또는 H100
- 시스템 메모리: 128GB 이상

**단점:**
- 비용 증가
- 시간 소요

**결론:** **현재 하드웨어로 충분합니다.**

---

## 3. 권장 해결 방안

### 3.1 즉시 실행 가능한 조치

#### 1. Swap 메모리 활성화 (최우선)

**목적:** 메모리 부족 시 대체 공간 제공

**실행 방법:**
```bash
# Swap 파일 생성 (32GB)
sudo fallocate -l 32G /swapfile
sudo chmod 600 /swapfile
sudo mkswap /swapfile
sudo swapon /swapfile

# 영구적으로 활성화
echo '/swapfile none swap sw 0 0' | sudo tee -a /etc/fstab

# 확인
swapon --show
```

**효과:**
- 메모리 부족 시 Swap으로 대체
- OOM Killer 발생 가능성 대폭 감소
- 시스템 안정성 향상

#### 2. 메모리 모니터링 스크립트

**목적:** 실시간 메모리 사용량 확인

**스크립트 작성:**
```bash
#!/bin/bash
# monitor_memory.sh
watch -n 5 'echo "=== GPU Memory ===" && nvidia-smi --query-gpu=memory.used,memory.total --format=csv && echo "" && echo "=== System Memory ===" && free -h'
```

#### 3. 코드 개선 (메모리 정리 강화)

**목적:** 메모리 사용량 최소화

**개선 사항:**
- 각 질문 처리 후 중간 정리
- 배치 처리로 메모리 사용량 분산
- 명시적 메모리 해제

---

### 3.2 전체 Validation Set 테스트 전략

#### 전략 1: 배치 처리 (권장)

**방법:**
- 전체 2,223개 질문을 100-200개씩 배치로 나누어 처리
- 각 배치 완료 후 메모리 정리
- 중간 저장으로 진행 상황 보존

**장점:**
- 메모리 사용량 안정적
- 중단 시 재개 가능
- 진행 상황 추적 용이

#### 전략 2: 순차 처리

**방법:**
- 한 번에 하나씩 순차 처리
- 각 질문 완료 후 즉시 저장
- 메모리 정리 주기적 실행

**장점:**
- 메모리 사용량 최소
- 안정성 높음

---

## 4. 최종 권장 사항

### 4.1 모델 선택

**✅ 선정된 모델 그대로 사용: `MLP-KTLim/llama-3-Korean-Bllossom-8B`**

**이유:**
1. 이미 검증 완료 (성공률 100%)
2. 메모리 문제 없음
3. 가장 빠른 응답 속도
4. 최고 성능

### 4.2 실행 전 필수 조치

1. **Swap 메모리 활성화** (최우선)
   - 32GB Swap 파일 생성
   - 시스템 안정성 향상

2. **메모리 모니터링 시작**
   - 실시간 메모리 사용량 확인
   - 경고 알림 설정

3. **코드 개선 적용**
   - 배치 처리 구현
   - 메모리 정리 강화

### 4.3 실행 방법

**백그라운드 실행:**
```bash
cd /home/pencilfoxs/00_new/History_Docent/06_LLM_Evaluation
./run_full_test_background.sh
```

**상태 확인:**
```bash
./check_full_test_status.sh
```

**중지:**
```bash
./stop_full_test.sh
```

---

## 5. 예상 결과

### 5.1 Swap 활성화 후

**메모리 상황:**
- GPU 메모리: 40GB (Bllossom-8B 사용 약 16GB, 여유 24GB)
- 시스템 메모리: 87.5GB + Swap 32GB = 119.5GB
- 안정성: 대폭 향상

### 5.2 전체 테스트 완료 후

**예상 결과:**
- 총 2,223개 질문 처리 완료
- 성공률: 95% 이상 유지 예상
- 평균 지연시간: 7-10초 예상
- 총 소요 시간: 4-5시간 예상

---

## 6. 결론

### 6.1 모델 선택

**✅ 선정된 모델 그대로 사용 권장**

- `MLP-KTLim/llama-3-Korean-Bllossom-8B`는 메모리 문제 없이 정상 작동
- 다른 모델로 변경할 필요 없음
- 현재 하드웨어로 충분

### 6.2 필수 조치

1. **Swap 메모리 활성화** (즉시 실행)
2. **메모리 모니터링** (실행 중)
3. **배치 처리** (코드 개선)

### 6.3 실행 계획

1. Swap 메모리 활성화
2. 메모리 모니터링 시작
3. 백그라운드 실행
4. 진행 상황 확인

---

**작성자:** AI Assistant  
**작성 일시:** 2025-11-23 15:00  
**상태:** ✅ 해결 방안 제시 완료

